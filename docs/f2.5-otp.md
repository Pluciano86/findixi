# F2.5 OTP (SMS + Voice) — Implementado con Adapter

## Estado
- Flujo OTP activo en `public/registroComercio.html` + `public/js/registroComercio.js`.
- Backend OTP activo con Netlify Functions:
  - `/.netlify/functions/send_otp`
  - `/.netlify/functions/verify_otp`
  - `/.netlify/functions/resend_otp`
- Adapter de proveedor listo en `netlify/functions/otpProvider.js` (`mock`, `twilio`, `telnyx`).
- Sin dependencia fija de proveedor en frontend.

## Variables de entorno requeridas
- `SUPABASE_URL`
- `SUPABASE_SERVICE_ROLE_KEY`
- `OTP_HASH_SECRET` (obligatoria en producción, valor largo y privado)
- `OTP_PROVIDER` (`mock` | `twilio` | `telnyx`)

Opcionales para desarrollo:
- `OTP_EXPOSE_CODE=true` (solo local; devuelve `dev_code` en respuesta)

## Si usas Twilio
- `TWILIO_ACCOUNT_SID`
- `TWILIO_AUTH_TOKEN`
- `TWILIO_PHONE_NUMBER`

## Si usas Telnyx
- `TELNYX_API_KEY`
- `TELNYX_MESSAGING_PROFILE_ID` o `TELNYX_FROM_NUMBER`

Nota:
- SMS Telnyx está preparado.
- Voice Telnyx queda como `not implemented` hasta definir Call Control exacto.

## Seguridad implementada
- OTP 6 dígitos.
- Hash SHA-256 antes de guardar (`hashed_code`), nunca código en texto plano.
- Expiración 10 minutos.
- Máx 5 intentos por challenge.
- Cooldown de reenvío: 60 segundos.
- Rate limit:
  - 5 OTP/h por comercio
  - 10 OTP/h por IP
  - 10 OTP/h por usuario
- Validación OTP solo en backend.
- Logs de auditoría básicos (`[OTP][SEND]`, `[OTP][VERIFY_OK]`).

## Notas de ejecución local
- Usa `netlify dev` para habilitar `/.netlify/functions/*`.
- Si corres con servidor estático puro (`:5500`), OTP no funcionará por ausencia de functions.

## Migración DB
- Ejecutar: `supabase/migrations/20260219160000_f25_otp_verification.sql`
- Crea estados OTP/propiedad, tabla `otp_challenges`, índices y triggers de protección:
  - preservar `telefono_referencia_google`
  - marcar `telefono_publico_verificado=false` + `estado_verificacion=otp_pendiente` cuando cambia teléfono
