<!DOCTYPE html>
<html lang="es">
<head>
  <link rel="icon" type="image/png" href="https://zgjaxanqfkweslkxtayt.supabase.co/storage/v1/object/public/findixi/loader.png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vincular Clover</title>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; max-width: 640px; margin: 40px auto; padding: 0 16px; line-height: 1.5; }
    h1 { margin-bottom: 0.25rem; }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.04); }
    label { display: block; margin-top: 12px; font-weight: 600; }
    input[type="number"] { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px; }
    button { margin-top: 16px; padding: 12px 16px; font-size: 16px; border: none; border-radius: 10px; color: #fff; background: #2563eb; cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .hint { color: #6b7280; font-size: 14px; margin-top: 4px; }
    .error { color: #b91c1c; margin-top: 12px; }
    .ok { color: #065f46; margin-top: 12px; }
    .warning { color: #b45309; margin-top: 12px; }
  </style>
</head>
<body>
  <h1>Vincular Clover</h1>
  <div class="card">
    <p id="info">Cargando...</p>

    <div id="formContainer" style="display:none;">
      <label for="idComercio">ID de Comercio (Supabase)</label>
      <input type="number" id="idComercio" placeholder="Ej: 123" min="1" />
      <p class="hint">Ingresa el ID numérico del comercio al que quieres vincular este merchant de Clover.</p>

      <button id="btnContinuar">Continuar con OAuth</button>
      <p id="msg" class="error" style="display:none;"></p>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const merchantId = params.get('merchant_id') || params.get('merchantId') || params.get('merchant');
    const infoEl = document.getElementById('info');
    const formContainer = document.getElementById('formContainer');
    const inputIdComercio = document.getElementById('idComercio');
    const btnContinuar = document.getElementById('btnContinuar');
    const msgEl = document.getElementById('msg');

    if (merchantId) {
      infoEl.innerText = 'Merchant ID recibido: ' + merchantId;
      infoEl.className = 'ok';
    } else {
      infoEl.innerText = 'No se recibió merchant_id. Puedes continuar; el flujo OAuth igual funciona.';
      infoEl.className = 'warning';
    }
    formContainer.style.display = 'block';

    btnContinuar?.addEventListener('click', () => {
      msgEl.style.display = 'none';
      const idComercio = Number(inputIdComercio.value);
      if (!Number.isFinite(idComercio) || idComercio <= 0) {
        msgEl.textContent = 'Debes ingresar un idComercio numérico mayor que 0.';
        msgEl.style.display = 'block';
        return;
      }

      const query = new URLSearchParams();
      query.set('idComercio', idComercio);
      if (merchantId) query.set('merchant_id', merchantId);

      const target = `/functions/v1/clover-oauth-start?${query.toString()}`;
      window.location.href = target;
    });
  </script>
</body>
</html>
